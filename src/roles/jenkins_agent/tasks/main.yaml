---
- name: Get ip address
  shell: |
    getent ahostsv4 {{ inventory_hostname }} | grep STREAM | head -n 1 | awk '{print $1}'
  register: internal_ip_command

- name: Debugging message
  debug:
    msg: "Setting up {{ inventory_hostname }} @ {{ internal_ip_command.stdout }}"

- name: Install dependencies
  ansible.builtin.apt:
    name:
      - openjdk-17-jdk
    state: present
    update_cache: yes

- name: Download jenkins swarm client
  get_url:
    url: https://repo.jenkins-ci.org/releases/org/jenkins-ci/plugins/swarm-client/3.25/swarm-client-3.25.jar
    dest: /root/swarm-client.jar

- name: Register agent with jenkins master
  shell: |
    nohup java -jar /root/swarm-client.jar \
    -master http://commander:8080 \
    -name "{{ inventory_hostname }}" \
    -labels "agent" \
    -executors 1 > /root/swarm-client.log 2>&1 &
